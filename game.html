<!DOCTYPE html>
<html>
<head>
    <title>Mi Juego P2P</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        .error { color: red; }
        .success { color: green; }
        button:disabled { opacity: 0.5; }

        .host-name { /*font-weight: bold;*/ color: #34495e; }
        .player-name { color: #34495e; }
        .player-list {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .player-list h4 {
            margin-top: 0;
            color: #333;
        }
        .player-list ul {
            list-style: none;
            padding: 0;
        }
        .player-list li {
            padding: 8px;
            margin: 5px 0;
            background-color: white;
            border-radius: 3px;
            border: 1px solid;
            border-left: 10px solid;
            
            border-color: #3498db;
        }
        .player-list li.host {
            background-color: #fffff6;
            border-color: #ffed65;
        }
    </style>
</head>
<body>
    <div id= "main-menu" style="display:block;">
        <div id="name-section">
        <input type="text" id="player-name" placeholder="Tu nombre" maxlength="20">
        </div>
        
        <input id="roomCode" placeholder="C贸digo de sala">

        <div>
            <button onclick="createRoom()" id="createBtn">Crear Sala</button>
        </div>
        
        <div>
            <button onclick="joinRoom()" id="joinBtn">Unirse</button>
        </div>
    </div>
    
    
    <div id="room-menu" style="display:none;">
        <h3>ID de tu sala: <span id="displayRoomCode"></span></h3>
        <div id="connection-status"></div>
        
        <!-- Lista de jugadores conectados -->
        <div class="player-list">
            <h4>Jugadores:</h4>
            <ul id="players-list">
                <!-- Se llena din谩micamente -->
            </ul>
        </div>
        
        <button onclick="cancelRoom()" id="cancelBtn">Atr谩s</button>
        
    </div>
    
    <div id="error-message" class="error"></div>

    <script>
        
        class RoomData {
            static peer;
            static conn;
            static isHost = false;
            static roomId = null;
            static myName = '';
            static players = [];
           

        }

        class UI{

            static WINDOWS = {
                MAIN_MENU: 1,
                ROOM_MENU: 2,
                GAME_MENU: 3,
            };

            static _currentWindow = UI.WINDOWS.MAIN_MENU;
            static setCurrentWindow(newWindow) {
                _currentWindow = newWindow;
                switch(newWindow){
                    case UI.WINDOWS.MAIN_MENU:
                        break;
                    case UI.WINDOWS.ROOM_MENU:
                        break;
                    case UI.WINDOWS.GAME_MENU:
                        break;
                }
            }

            static showError(msg) {
                document.getElementById('error-message').textContent = msg;
            }

            static setPlayerList(playerList) {
                const listElement = document.getElementById('players-list');
                listElement.innerHTML = '';
                
                playerList.forEach(player => {
                    const li = document.createElement('li');
                    li.className = player.isHost ? 'host' : '';
                    
                    const icon = player.isHost ? ' ' : ' ';
                    const name = player.isHost ? 
                        `<span class="host-name">${player.name}</span>` : 
                        `<span class="player-name">${player.name}</span>`;
                    
                    // Marcar mi nombre si soy yo
                    const isMe = player.id === RoomData.peer?.id;
                    const mark = isMe ? ' (t煤)' : '';
                    
                    li.innerHTML = `${icon}${name}${mark}`;
                    listElement.appendChild(li);
                });
                
                // Si no hay jugadores, mostrar mensaje
                if (playerList.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = 'No hay jugadores en la sala';
                    li.style.fontStyle = 'italic';
                    li.style.color = '#999';
                    listaElement.appendChild(li);
                }
            }
        }
        
        
        function createRoom() {
            UI.showError('');
            
            RoomData.myName = document.getElementById('player-name').value.trim();

            if(!RoomData.myName){
                UI.showError('Elige un nombre');
                return;
            }
            RoomData.roomId = document.getElementById('roomCode').value.trim();
    
            // Si no pusieron c贸digo, generar uno de 4 d铆gitos
            if (!RoomData.roomId) {
                RoomData.roomId = Math.floor(1000 + Math.random() * 9000).toString();
            } else if (!/^\d{4}$/.test(RoomData.roomId)) {
                UI.showError('El c贸digo debe ser de 4 d铆gitos');
                return;
            }
            
            // Crear Peer con el c贸digo del input
            RoomData.peer = new Peer(RoomData.roomId);
            
            RoomData.peer.on('open', (id) => {
                RoomData.roomId = id;
                RoomData.isHost = true;
                
                // Agregarme a la lista de jugadores como host
                RoomData.players = [{
                    id: RoomData.peer.id,
                    name: RoomData.myName,
                    isHost: true
                }];
                
                UI.setPlayerList(RoomData.players);
                
                setMainMenuEnabled(false);
                document.getElementById('room-menu').style.display = 'block';
                document.getElementById('displayRoomCode').textContent = id;
                
                // Escuchar conexiones de jugadores
                RoomData.peer.on('connection', (connection) => {
                    RoomData.conn = connection;
                    
                    RoomData.conn.on('data', (data) => {
                        handleGameData(data);
                    });
                    
                    RoomData.conn.on('close', () => {
                        // Quitar jugador desconectado de la lista
                        RoomData.players = RoomData.players.filter(j => j.id !== RoomData.conn.peer);
                        UI.setPlayerList(RoomData.players);
                    });
                    
                    // Enviar lista actual de jugadores al reci茅n conectado
                    setTimeout(() => {
                        RoomData.conn.send({
                            type: 'players_list',
                            players: RoomData.players
                        });
                    }, 500);
                });
            });
            
            RoomData.peer.on('error', (error) => {
                UI.showError('Error al crear sala: ' + error.type);
                setMainMenuEnabled(true);
            });
        }
        
        function joinRoom() {
            RoomData.roomId = document.getElementById('roomCode').value.trim();

            RoomData.myName = document.getElementById('player-name').value.trim();

            if(!RoomData.myName){
                UI.showError('Elige un nombre');
                return;
            }

            if (!RoomData.roomId) {
                UI.showError('Ingresa un c贸digo de sala');
                return;
            }
            
            UI.showError('');
            
            RoomData.peer = new Peer();
            
            RoomData.peer.on('open', () => {
                RoomData.conn = RoomData.peer.connect(RoomData.roomId);
                
                // Timeout por si no se puede conectar
                const connectionTimeout = setTimeout(() => {
                    UI.showError('No se pudo conectar a la sala.');
                    setMainMenuEnabled(true);
                    RoomData.peer.destroy();
                }, 5000);
                
                RoomData.conn.on('open', () => {
                    clearTimeout(connectionTimeout);
                    RoomData.isHost = false;
                    
                    setMainMenuEnabled(false);
                    document.getElementById('room-menu').style.display = 'block';
                    document.getElementById('displayRoomCode').textContent = RoomData.roomId;
                    
                    // Enviar mi nombre al host
                    RoomData.conn.send({ 
                        type: 'new_player',
                        name: RoomData.myName,
                        id: RoomData.peer.id
                    });
                });
                
                RoomData.conn.on('data', (data) => {
                    handleGameData(data);
                });
                
                RoomData.conn.on('close', () => {
                    RoomData.players = [];
                    resetToLobby();
                    UI.showError("El host cerr贸 la sala");
                });
                
                RoomData.conn.on('error', (error) => {
                    UI.showError('Error de conexi贸n: ' + error);
                });
            });
            
            RoomData.peer.on('error', (error) => {
                UI.showError('Error al unirse: ' + error.type);
                setMainMenuEnabled(true);
            });
        }
        
        function handleGameData(data) {
            console.log('Datos recibidos:', data);
            
            switch(data.type) {
                case 'new_player':
                    // Host recibe nuevo jugador
                    const newPlayer = {
                        id: data.id,
                        name: data.name,
                        isHost: false
                    };
                    RoomData.players.push(newPlayer);
                    UI.setPlayerList(RoomData.players);
                    
                    // Notificar a todos (incluyendo al nuevo) la lista actualizada
                    if (RoomData.conn) {
                        RoomData.conn.send({
                            type: 'lista_jugadores',
                            players: RoomData.players
                        });
                    }
                    break;
                    
                case 'players_list':
                    // Jugador recibe lista actualizada del host
                    RoomData.players = data.players;
                    UI.setPlayerList(RoomData.players);
                    break;
                    
                default:
            }
        }
        
        
        
        function cancelRoom() {
            if (peer) {
                RoomData.peer.destroy();
            }
            resetToLobby();
        }
        
        function resetToLobby() {
            RoomData.players = [];
            actualizarListaJugadores();
            
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('players').innerHTML = '';
            document.getElementById('error-message').textContent = '';
            setMainMenuEnabled(true);
        }
        
        
        
        function setMainMenuEnabled(enabled) {
            if(enabled)
                document.getElementById('main-menu').style.display = 'block';
            else
                document.getElementById('main-menu').style.display = 'none';
        }
        
        // Limpiar todo si se cierra la pesta帽a
        window.addEventListener('beforeunload', () => {
            if (RoomData.peer) {
                RoomData.peer.destroy();
            }
        });
    </script>
</body>
</html>