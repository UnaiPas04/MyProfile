<!DOCTYPE html>
<html>
<head>
    <title>Color Wars</title>
    <!-- Peer 2 Peer -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <!--Bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

    <!-- Cargar CSS -->
    <link rel="stylesheet" href="stylesGame.css">

    <style>
        
    </style>
</head>
<body>
    <div class ="container-fluid d-flex align-items-center justify-content-center">
        <div id= "main-menu" style="display:block;" class = "main-menu position-fixed top-50 start-50 translate-middle">
            
            <div class="d-flex flex-column justify-content-center align-items-center gap-2 p-2">
                <input type="text" id="player-name" placeholder="Tu nombre" maxlength="20"
                class="form-control text-center rounded-4">
                <input id="roomCode" placeholder="C贸digo de sala" maxlength="4"
                class="form-control text-center rounded-4">

                <div class="w-100">
                    <button onclick="createRoom()" id="createBtn"
                    class="btn btn-primary w-100 rounded-4">Crear Sala</button>
                </div>
                
                <div class="w-100">
                    <button onclick="joinRoom()" id="joinBtn"
                    class="btn btn-primary w-100 rounded-4">Unirse</button>
                </div>
            </div>
        </div>
        
        
        <div id="room-menu" style="display:none; " class = "room-menu mt-5 p-2">
            
            <div class="d-flex flex-column justify-content-center align-items-center gap-2 p-2"></div>
                <h4>ID Sala: <span id="displayRoomCode"></span></h4>
                <div id="connection-status"></div>
                
                <!-- Lista de jugadores conectados -->
                <div class="player-list">
                    <ul id="players-list">
                        <!-- Se llena din谩micamente -->
                    </ul>
                </div>
            
               
                <button onclick="cancelRoom()" id="cancelBtn"
                class="btn btn-primary w-30 rounded-4">Atr谩s</button>
                
                <button onclick="startGame()" style="margin-top: 10px;" id="startBtn"
                class="btn btn-primary w-30 rounded-4"
                style="display:none; ">Empezar Partida</button>
                
            </div>
        </div>
        
        <div id="game-menu" style="display:none;">
            
        </div>

        <div id="error-message" class="error"></div>
    </div>
    

    <script>
        
        class RoomData {
            static peer;
            static hostConnection; //lo usan clientes para hablar con el host
            static clientsConnections = []; //lo usa el host para hablar con clientes
            static isHost = false;
            static roomId = null;
            static myName = '';
            static players = [];

            static AddClientConn(conn) {
                if (!this.isHost) throw new Error('Only Host');
                
                // Agregar la conexi贸n al array
                this.clientsConnections.push(conn);
                
                // Configurar evento para removerla autom谩ticamente cuando se cierre
                conn.on('close', () => {
                    this.RemoveClientConn(conn);
                });
                
                conn.on('data', (data) => {
                    this.HandleData(data);
                });

                console.log(`Cliente conectado. Total: ${this.clientsConnections.length}`);
            }

            static RemoveClientConn(conn) {
                if (!this.isHost) throw new Error('Only Host');
                
                const index = this.clientsConnections.indexOf(conn);
                if (index > -1) {
                    this.clientsConnections.splice(index, 1);
                    console.log(`Cliente removido. Quedan: ${this.clientsConnections.length}`);
                }

                //Quitar de la lista players
                this.players = this.players.filter(j => j.id !== conn.peer); //esta linea da error

                //Avisar a todos del cambio
                this.SendMessageToClients({
                        type: 'players_list',
                        players: RoomData.players
                    });
                
                UI.setPlayerList(this.players);
            }

            static SetHostConn(conn) {
                if (this.isHost) throw new Error('Only Clients');
                
                this.hostConnection = conn;

                this.hostConnection.on('data', (data) => {
                    this.HandleData(data);
                });
            }

            static SendMessageToHost(msg){
                if(this.isHost) throw new Error('Only Clients');

                if(this.hostConnection){
                    this.hostConnection.send(msg);
                }
                else{
                    throw new Error('First Init Host');
                }
            }

            static SendMessageToClients(msg) {
                if (!this.isHost) throw new Error('Only Host');
                
                // Enviar a todos los clientes
                this.clientsConnections.forEach(conn => {
                    if (conn && conn.open) {
                        conn.send(msg);
                    }
                });
            }
            static SendMessageToClient(clientId, msg) {
                if (!this.isHost) throw new Error('Only Host');
                
                // Buscar la conexi贸n por el peer.id del cliente
                const connection = this.clientsConnections.find(conn => conn.peer === clientId);
                
                if (connection && connection.open) {
                    connection.send(msg);
                }
            }

            static HandleData(data) {
                console.log('Datos recibidos:', data);
                
                switch(data.type) {
                    case 'new_player':
                        //Host recibe info de un cliente
                        //Si no cabe, decirselo
                        if(this.players.length >= 6){
                            console.log("aqui");                            
                            this.SendMessageToClient(data.id, 
                            {
                                type: 'room_full'
                            });
                            return;
                        }
                        //Si cabe:
                        // Host recibe nuevo jugador
                        console.log("alla");
                        const newPlayer = {
                            id: data.id,
                            name: data.name,
                            isHost: false
                        };
                        this.players.push(newPlayer);
                        UI.setPlayerList(this.players);
                        
                        // Notificar a todos  la lista actualizada

                        this.SendMessageToClients({
                            type: 'players_list',
                            players: RoomData.players
                        });
                        break;
                        
                    case 'players_list':
                        // Jugador recibe lista actualizada del host
                        this.players = data.players;
                        UI.setPlayerList(this.players);
                        break;
                        
                    case 'room_full':
                        UI.setCurrentWindow(UI.WINDOWS.MAIN_MENU);
                        UI.showError('Sala llena');
                        break;
                    case 'start_game':
                        UI.setCurrentWindow(UI.WINDOWS.GAME_MENU);
                        break;
                    default:
                }
            }
        }

        class UI{

            static WINDOWS = {
                MAIN_MENU: 1,
                ROOM_MENU: 2,
                GAME_MENU: 3,
            };

            static _currentWindow = UI.WINDOWS.MAIN_MENU;
            static setCurrentWindow(newWindow) {
                UI._currentWindow = newWindow;

                //Activar la correspondiente
                const mainDisplay = newWindow === UI.WINDOWS.MAIN_MENU? 'block': 'none';
                document.getElementById('main-menu').style.display = mainDisplay;

                const roomDisplay = newWindow === UI.WINDOWS.ROOM_MENU? 'block': 'none';
                document.getElementById('room-menu').style.display = roomDisplay;

                const gameDisplay = newWindow === UI.WINDOWS.GAME_MENU? 'block': 'none';
                document.getElementById('game-menu').style.display = gameDisplay;

                const startButtDisplay = (newWindow === UI.WINDOWS.ROOM_MENU && RoomData.isHost)? 'block': 'none';
                document.getElementById('startBtn').style.display = startButtDisplay;
                
            }

            static showError(msg) {
                document.getElementById('error-message').textContent = msg;
            }

            static setPlayerList(playerList) {
                const listElement = document.getElementById('players-list');
                listElement.innerHTML = '';
                
                let i = 0;
                playerList.forEach(player => {
                    const li = document.createElement('li');
                    li.className = 'p'+i;
                    
                    const icon = player.isHost ? ' ' : ' ';
                    const name = player.isHost ? 
                        `<span class="player-name">${player.name}</span>` : 
                        `<span class="player-name">${player.name}</span>`;
                    
                    // Marcar mi nombre si soy yo
                    const isMe = player.id === RoomData.peer?.id;
                    const mark = isMe ? ' (t煤)' : '';
                    
                    li.innerHTML = `${icon}${name}${mark}`;
                    listElement.appendChild(li);

                    i++;
                });
                
                // Si no hay jugadores, mostrar mensaje
                if (playerList.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = 'No hay jugadores en la sala';
                    li.style.fontStyle = 'italic';
                    li.style.color = '#999';
                    listElement.appendChild(li);
                }
            }
        
            static setRoomCode(roomCode){
                document.getElementById('displayRoomCode').textContent = roomCode;
            }
        }
        
        
        function createRoom() {
            //El host crea una sala

            UI.showError('');
            
            RoomData.myName = document.getElementById('player-name').value.trim();

            if(!RoomData.myName){
                UI.showError('Elige un nombre');
                return;
            }
            RoomData.roomId = document.getElementById('roomCode').value.trim();
    
            // Si no pusieron c贸digo, generar uno de 4 d铆gitos
            if (!RoomData.roomId) {
                RoomData.roomId = Math.floor(1000 + Math.random() * 9000).toString();
            } else if (!/^\d{4}$/.test(RoomData.roomId)) {
                UI.showError('El c贸digo debe ser de 4 d铆gitos');
                return;
            }
            
            // Crear Peer con el c贸digo del input
            RoomData.peer = new Peer(RoomData.roomId);
            
            RoomData.peer.on('open', (id) => {
                RoomData.roomId = id;
                RoomData.isHost = true;
                
                // Agregarme a la lista de jugadores como host
                RoomData.players = [{
                    id: RoomData.peer.id,
                    name: RoomData.myName,
                    isHost: true
                }];
                
                UI.setCurrentWindow(UI.WINDOWS.ROOM_MENU);
                UI.setPlayerList(RoomData.players);
                UI.setRoomCode(id);
                
                // Escuchar conexiones de jugadores
                RoomData.peer.on('connection', (connection) => {
                    RoomData.AddClientConn(connection);
                    
                    // Enviar lista actual de jugadores a todos los clientes conectados
                    setTimeout(() => {
                        RoomData.SendMessageToClients({
                            type: 'players_list',
                            players: RoomData.players
                        });
                    }, 500);
                });
            });
            
            RoomData.peer.on('error', (error) => {
                UI.setCurrentWindow(UI.WINDOWS.MAIN_MENU);
                UI.showError('Error al crear sala: ' + error.type);
            });
        }
        
        function joinRoom() {
            RoomData.roomId = document.getElementById('roomCode').value.trim();
            RoomData.myName = document.getElementById('player-name').value.trim();

            if(!RoomData.myName){
                UI.showError('Elige un nombre');
                return;
            }

            if (!RoomData.roomId) {
                UI.showError('Ingresa un c贸digo de sala');
                return;
            }
            
            UI.showError('');
            
            RoomData.peer = new Peer();
            
            RoomData.peer.on('open', () => {
                const hostConn = RoomData.peer.connect(RoomData.roomId);
                RoomData.SetHostConn(hostConn);

                // Timeout por si no se puede conectar
                const connectionTimeout = setTimeout(() => {
                    UI.setCurrentWindow(UI.WINDOWS.MAIN_MENU);
                    UI.showError('No se pudo conectar a la sala.');
                    RoomData.peer.destroy();
                }, 5000);
                
                RoomData.hostConnection.on('open', () => {
                    clearTimeout(connectionTimeout);
                    RoomData.isHost = false;
                    
                    UI.setCurrentWindow(UI.WINDOWS.ROOM_MENU);
                    UI.setRoomCode(RoomData.roomId);
                    
                    // Enviar mi nombre al host
                    RoomData.SendMessageToHost({ 
                        type: 'new_player',
                        name: RoomData.myName,
                        id: RoomData.peer.id
                    });
                });
                
                RoomData.hostConnection.on('close', () => {
                    cancelRoom();
                });
                
                RoomData.hostConnection.on('error', (error) => {
                    UI.showError('Error de conexi贸n: ' + error);
                });
            });
            
            RoomData.peer.on('error', (error) => {
                UI.setCurrentWindow(UI.WINDOWS.MAIN_MENU);
                UI.showError('Error al unirse: ' + error.type);
            });
        }
        
        function startGame(){
            UI.setCurrentWindow(UI.WINDOWS.GAME_MENU);

            RoomData.SendMessageToClients({
                type: 'start_game',
            });
        }

        function cancelRoom() {
            if (RoomData.peer) {
                RoomData.peer.destroy();
            }
            resetPlayersList();
            UI.setCurrentWindow(UI.WINDOWS.MAIN_MENU);
        }
        
        function resetPlayersList() {
            RoomData.players = [];
            UI.setPlayerList(RoomData.players);
        }
        // Limpiar todo si se cierra la pesta帽a
        window.addEventListener('beforeunload', () => {
            if (RoomData.peer) {
                RoomData.peer.destroy();
            }
        });
    </script>
</body>
</html>